import streamlit as st
from PIL import Image, ImageFilter, ImageDraw
from io import BytesIO

# é¡µé¢é…ç½®ï¼šè®¾ç½®æ ‡é¢˜å’Œå›¾æ ‡ï¼Œå¸ƒå±€è®¾ä¸ºå±…ä¸­
st.set_page_config(page_title="åœ†è§’æ¨¡ç³Šå·¥å…·", page_icon="ğŸ–¼ï¸")

st.title("ğŸ–¼ï¸ ç…§ç‰‡åœ†è§’æ¨¡ç³Šå·¥å…·")
st.markdown("ä¸Šä¼ ç…§ç‰‡ï¼Œè‡ªåŠ¨ç”Ÿæˆç±»ä¼¼ç›¸æ¡†çš„æ¨¡ç³ŠèƒŒæ™¯æ•ˆæœã€‚")

# --- ä¾§è¾¹æ ï¼šå‚æ•°è®¾ç½® ---
with st.sidebar:
    st.header("å‚æ•°è°ƒèŠ‚")
    # è®¾ç½®é»˜è®¤å€¼ï¼ŒèŒƒå›´æ ¹æ®ç»éªŒè°ƒæ•´
    blur_radius = st.slider("èƒŒæ™¯æ¨¡ç³Šç¨‹åº¦ (Blur)", 0, 100, 50, help="æ•°å€¼è¶Šå¤§ï¼ŒèƒŒæ™¯è¶Šæ¨¡ç³Š")
    corner_radius = st.slider("åœ†è§’å¤§å° (Radius)", 0, 300, 80, help="æ•°å€¼è¶Šå¤§ï¼Œè§’è¶Šåœ†")
    
    st.info("ğŸ’¡ æç¤ºï¼šè°ƒæ•´å‚æ•°åå›¾ç‰‡ä¼šè‡ªåŠ¨æ›´æ–°ã€‚")

# --- ä¸»ä½“é€»è¾‘ ---
uploaded_file = st.file_uploader("ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ (æ”¯æŒ JPG/PNG)", type=["jpg", "jpeg", "png"])

if uploaded_file is not None:
    try:
        # 1. è¯»å–å›¾ç‰‡
        original_image = Image.open(uploaded_file).convert("RGBA")
        
        # æ˜¾ç¤ºæ­£åœ¨å¤„ç†ï¼ˆè™½ç„¶é€šå¸¸å¾ˆå¿«ï¼‰
        with st.spinner('æ­£åœ¨å¤„ç†å›¾ç‰‡...'):
            width, height = original_image.size

            # 2. ç”Ÿæˆæ¨¡ç³ŠèƒŒæ™¯
            blurred_background = original_image.filter(ImageFilter.GaussianBlur(blur_radius))

            # 3. åˆ›å»ºåœ†è§’é®ç½©
            # è¿™é‡Œçš„ 'L' æ¨¡å¼è¡¨ç¤ºç°åº¦å›¾ï¼Œ255æ˜¯ç™½è‰²ï¼ˆä¸é€æ˜ï¼‰ï¼Œ0æ˜¯é»‘è‰²ï¼ˆé€æ˜ï¼‰
            mask = Image.new("L", (width, height), 0)
            draw = ImageDraw.Draw(mask)
            draw.rounded_rectangle((0, 0, width, height), radius=corner_radius, fill=255)

            # 4. åˆæˆæœ€ç»ˆå›¾åƒ
            final_image = Image.new("RGBA", (width, height))
            final_image.paste(blurred_background, (0, 0))
            # å°†åŸå›¾é€šè¿‡é®ç½©ç²˜è´´ä¸Šå»
            final_image.paste(original_image, (0, 0), mask=mask)

            # 5. è½¬æ¢ä¸ºå­—èŠ‚æµä»¥ä¾¿ä¸‹è½½å’Œæ˜¾ç¤º
            buf = BytesIO()
            final_image.save(buf, format="PNG")
            byte_im = buf.getvalue()

        # --- ç»“æœå±•ç¤º ---
        st.success("å¤„ç†å®Œæˆï¼")
        
        # åœ¨æ‰‹æœºä¸Šå±•ç¤ºå›¾ç‰‡ï¼Œuse_container_width=True ä¼šè®©å›¾ç‰‡è‡ªåŠ¨é€‚åº”æ‰‹æœºå±å¹•å®½åº¦
        st.image(final_image, caption="æ•ˆæœé¢„è§ˆ", use_container_width=True)

        # ä¸‹è½½æŒ‰é’®
        st.download_button(
            label="â¬‡ï¸ ä¸‹è½½å¤„ç†åçš„å›¾ç‰‡",
            data=byte_im,
            file_name="processed_image.png",
            mime="image/png",
            type="primary" # çªå‡ºæ˜¾ç¤ºæŒ‰é’®
        )

    except Exception as e:
        st.error(f"å‘ç”Ÿé”™è¯¯ï¼š{e}")
else:
    # è¿™é‡Œçš„æç¤ºåªæœ‰åœ¨æœªä¸Šä¼ æ—¶æ˜¾ç¤º
    st.info("ğŸ‘† è¯·å…ˆåœ¨ä¸Šæ–¹ä¸Šä¼ ä¸€å¼ å›¾ç‰‡")